FROM node:18-alpine AS development

# Set working directory
WORKDIR /app

# Install pnpm globally
RUN npm install -g pnpm@latest

# Copy package.json and pnpm-lock.yaml first for better caching
COPY package.json pnpm-lock.yaml* ./

# Install dependencies
RUN pnpm install

# Install Prisma CLI globally
RUN pnpm install -g prisma

# Copy source code
COPY . .

# Generate Prisma client
RUN pnpm run prisma:generate

# Expose API port
EXPOSE 8080

# Set proper permissions for node user
RUN chown -R node:node /app
USER node

# Health check
HEALTHCHECK --interval=30s --timeout=30s --start-period=30s --retries=3 \
  CMD wget --no-verbose --tries=1 --spider http://localhost:8080/api/health || exit 1

# Run app in development mode with hot reload (using nest start --watch via pnpm dev)
CMD ["pnpm", "run", "dev"]
